#!/bin/sh -e

# This script tries to generate config.mk
# based on the tool path and the board name.
# At some point this will probably have to
# be replaced with something more powerful,
# like kconfig.

TOOL_PREFIX=$1
TARGET=$2

[ -d ./board/$TARGET ] || {
	echo "usage: $0 <tool-prefix> <target path>" && exit 1
}
[ -z $TOOL_PREFIX ] && echo "usage: $0 <tool prefix> <target path>" && exit 1

OUTFILE=./board/${TARGET}/config

GCC=${TOOL_PREFIX}-gcc
LD=${TOOL_PREFIX}-ld
AS=${TOOL_PREFIX}-as
OBJCOPY=${TOOL_PREFIX}-objcopy

for prog in $GCC $LD $AS $OBJCOPY; do
    [ -z $(which $prog) ] && echo "$prog not in your PATH?" && exit 1
done

CFLAGS="-g -Os ${CFLAGS}"

# capture the cross-gcc linker paths
# so that a direct invocation of ld
# will include a path to libgcc.a and friends
LDPATH=$($GCC -print-search-dirs | sed -n 's/^libraries:\ =\(.*\)/\1/p')
for path in $(echo $LDPATH | tr ':' '\n'); do
	[ -d $path ] || continue
	path=$(readlink -nf $path)
	echo "including compiler path" $path
	LDFLAGS="-L${path} ${LDFLAGS}"
done

board=$(dirname ./board/${TARGET})
. ${board}/board.config

cat > ${OUTFILE} <<-EOF
# Autogenerated tool configuration
# DO NOT EDIT! Edit config.sh instead.
CC=$GCC
LD=$LD
AS=$AS
OBJCOPY=$OBJCOPY
CFLAGS=$CFLAGS
LDFLAGS=$LDFLAGS
EOF

cat ${board}/board.config arch/${CONFIG_ARCH}/arch.config mcu/${CONFIG_MCU}/mcu.config board/${TARGET}/target.config >> ${OUTFILE}
